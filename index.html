<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å‰²æ‰‹æ•°æ–™è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <style>
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .password-container {
            background: var(--color-surface);
            padding: 32px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .password-container h2 {
            margin-bottom: 16px;
            color: var(--color-primary);
            font-size: 18px;
        }

        .password-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
        }

        .password-container button {
            width: 100%;
            padding: 12px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .password-container button:hover {
            background: var(--color-primary-hover);
        }

        .password-error {
            color: var(--color-error);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .main-content {
            display: none;
        }

        .main-content.unlocked {
            display: block;
        }

        :root {
            --color-primary: #32b8c6;
            --color-primary-hover: #1d745f;
            --color-primary-active: #1a7273;
            --color-bg: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #208d8d;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
            --color-focus: rgba(33, 128, 141, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 12px;
            line-height: 1.5;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px 0;
            border-bottom: 2px solid var(--color-border);
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        section {
            background: var(--color-surface);
            border-radius: 8px;
            border: 1px solid var(--color-border);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        }

        section h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-text);
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-surface);
            color: var(--color-text);
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .product-item {
            background: #f5f5f5;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .product-item .form-group {
            margin-bottom: 8px;
        }

        .product-item input, .product-item select {
            padding: 8px;
            font-size: 13px;
        }

        .btn-remove {
            background: #f5f5f5;
            border: 1px solid var(--color-error);
            color: var(--color-error);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: rgba(192, 21, 47, 0.1);
        }

        button.btn-add {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
            transition: all 0.2s;
            margin-top: 8px;
        }

        button.btn-add:hover {
            background: var(--color-primary-hover);
        }

        .btn-calculate {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .btn-calculate:hover {
            background: var(--color-primary-hover);
        }

        .btn-calculate:active {
            background: var(--color-primary-active);
        }

        .history-item {
            background: #f9f9f9;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .history-time {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .history-customer {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .history-total {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .history-detail {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .btn-delete {
            background: rgba(192, 21, 47, 0.1);
            color: var(--color-error);
            border: 1px solid var(--color-error);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: 500;
            width: 100%;
        }

        .btn-delete:hover {
            background: rgba(192, 21, 47, 0.2);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: flex-end;
        }

        .modal-content {
            background: var(--color-surface);
            width: 100%;
            max-height: 90vh;
            border-radius: 12px 12px 0 0;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-close {
            background: var(--color-border);
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            width: 100%;
            margin-top: 12px;
        }

        .detail-section {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .detail-section h3 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px dotted var(--color-border);
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .empty-state {
            text-align: center;
            padding: 24px 12px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 13px;
        }

        .calculation-summary {
            background: linear-gradient(135deg, rgba(50, 184, 198, 0.05), rgba(50, 184, 198, 0.02));
            border-left: 4px solid var(--color-primary);
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px dotted var(--color-border);
        }

        .summary-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-label {
            color: var(--color-text-secondary);
        }

        .summary-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .download-btn {
            background: var(--color-success);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: #1a8c8c;
        }

        .skip-fee-breakdown {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--color-border);
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-container">
            <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç•ªå·">
            <button onclick="checkPassword()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="passwordError" class="password-error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <header>
                <h1>åˆ†å‰²æ‰‹æ•°æ–™è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>
                <p class="subtitle">å•†å“è¨ˆç®— Ã— æ”¯æ‰•ã„æ‰‹æ•°æ–™</p>
            </header>

            <button class="download-btn" onclick="downloadApp()">ğŸ“¥ ã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('calculator')">è¨ˆç®—</button>
                <button class="tab-btn" onclick="switchTab('history')">å±¥æ­´</button>
                <button class="tab-btn" onclick="switchTab('preset')">ãƒªã‚¹ãƒˆç®¡ç†</button>
            </div>

            <!-- è¨ˆç®—ã‚¿ãƒ– -->
            <div id="calculator" class="tab-content active">
                <section>
                    <h2>åŸºæœ¬æƒ…å ±</h2>
                    <div class="form-group">
                        <label>é¡§å®¢ç¨®åˆ¥</label>
                        <select id="customerType" onchange="updateCalculation()">
                            <option value="student">ä¿®ç§‘ç”Ÿ</option>
                            <option value="member">ã—ã‚…ã†ç¾ä¼šç”Ÿ</option>
                            <option value="instructor">è¬›å¸«</option>
                        </select>
                    </div>
                </section>

                <section>
                    <h2>å•†å“æƒ…å ±</h2>
                    <div id="productsList"></div>
                    <button class="btn-add" onclick="addProduct(); return false;">+ å•†å“ã‚’è¿½åŠ </button>
                </section>

                <section id="cardSelectionsSection"></section>

                <button class="btn-calculate" onclick="saveToHistory()">è¨ˆç®—çµæœã‚’ä¿å­˜</button>

                <section id="resultsSection" style="display: none;">
                    <h2>è¨ˆç®—çµæœ</h2>
                    <div class="calculation-summary" id="summaryDetails"></div>
                </section>
            </div>

            <!-- å±¥æ­´ã‚¿ãƒ– -->
            <div id="history" class="tab-content">
                <section id="historySection"></section>
            </div>

            <!-- ãƒªã‚¹ãƒˆç®¡ç†ã‚¿ãƒ– -->
            <div id="preset" class="tab-content">
                <section>
                    <h2>ã‚«ãƒ¼ãƒ‰ç¨®é¡ç®¡ç†</h2>
                    <div id="cardTypesTable"></div>
                    <button class="btn-add" onclick="addCardType(); return false;">+ ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’è¿½åŠ </button>
                </section>
                <section>
                    <h2>ã‚«ãƒ¼ãƒ‰æ‰‹æ•°æ–™ç®¡ç†</h2>
                    <div id="cardPaymentTable"></div>
                </section>
                <section>
                    <h2>ã‚¹ã‚­ãƒƒãƒ—æ‰‹æ•°æ–™ç®¡ç†</h2>
                    <div id="cardSkipFeeTable"></div>
                </section>
                <section>
                    <h2>ã‚¬ãƒ¼ãƒ‰ç®¡ç†</h2>
                    <div id="guardList"></div>
                    <button class="btn-add" onclick="addPresetItem('guard'); return false;">+ ã‚¬ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
                </section>
                <section>
                    <h2>è£ç‰©ç®¡ç†</h2>
                    <div id="liningList"></div>
                    <button class="btn-add" onclick="addPresetItem('lining'); return false;">+ è£ç‰©ã‚’è¿½åŠ </button>
                </section>
                <section>
                    <h2>ä»•ç«‹ç®¡ç†</h2>
                    <div id="tailorList"></div>
                    <button class="btn-add" onclick="addPresetItem('tailor'); return false;">+ ä»•ç«‹ã‚’è¿½åŠ </button>
                </section>
                <section>
                    <h2>ãã®ä»–ç®¡ç†</h2>
                    <div id="otherList"></div>
                    <button class="btn-add" onclick="addPresetItem('other'); return false;">+ ãã®ä»–ã‚’è¿½åŠ </button>
                </section>
                <section>
                    <h2>ãã®ä»–ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰²å¼•è¨­å®š</h2>
                    <div id="categoryDiscountList"></div>
                </section>
            </div>

            <div class="modal" id="detailModal">
                <div class="modal-content" id="detailContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–
        let cardTypes = [];
        let categoryDiscounts = {};

        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
        let presetData = {
            guard: [
                { id: 1, name: 'ã‚¬ãƒ¼ãƒ‰ï¼ˆæ¨™æº–ï¼‰', price: 3000 },
                { id: 2, name: 'ã‚¬ãƒ¼ãƒ‰ï¼ˆåšæ‰‹ï¼‰', price: 4000 },
                { id: 3, name: 'ã‚¬ãƒ¼ãƒ‰ï¼ˆç‰¹æ®Šï¼‰', price: 5000 }
            ],
            lining: [
                { id: 4, name: 'è£ç‰©ï¼ˆæ¨™æº–ï¼‰', price: 2000 },
                { id: 5, name: 'è£ç‰©ï¼ˆä¸Šè³ªï¼‰', price: 3500 },
                { id: 6, name: 'è£ç‰©ï¼ˆç‰¹æ®Šï¼‰', price: 4500 }
            ],
            tailor: [
                { id: 7, name: 'ä»•ç«‹ï¼ˆæ¨™æº–ï¼‰', price: 15000 },
                { id: 8, name: 'ä»•ç«‹ï¼ˆé«˜ç´šï¼‰', price: 25000 },
                { id: 9, name: 'ä»•ç«‹ï¼ˆç‰¹æ®Šï¼‰', price: 35000 }
            ],
            other: [
                { id: 10, name: 'ãã®ä»–ï¼ˆÂ¥5,000ï¼‰', price: 5000 },
                { id: 11, name: 'ãã®ä»–ï¼ˆÂ¥10,000ï¼‰', price: 10000 },
                { id: 12, name: 'ãã®ä»–ï¼ˆÂ¥15,000ï¼‰', price: 15000 }
            ]
        };

        let feeStructureData = {
            jackx: [
                { payments: 1, fee: 0 },
                { payments: 3, fee: 0 },
                { payments: 6, fee: 0 },
                { payments: 10, fee: 0 },
                { payments: 12, fee: 1.2 },
                { payments: 15, fee: 3.0 },
                { payments: 18, fee: 4.8 },
                { payments: 20, fee: 6.0 },
                { payments: 24, fee: 8.4 },
                { payments: 30, fee: 12.0 },
                { payments: 36, fee: 15.6 }
            ],
            kl: [
                { payments: 1, fee: 0 },
                { payments: 3, fee: 0 },
                { payments: 6, fee: 0 },
                { payments: 10, fee: 0 },
                { payments: 12, fee: 1.0 },
                { payments: 15, fee: 2.1 },
                { payments: 18, fee: 3.1 },
                { payments: 20, fee: 3.8 },
                { payments: 24, fee: 5.2 },
                { payments: 30, fee: 7.3 },
                { payments: 36, fee: 9.4 }
            ]
        };

        const categoryLabels = {
            'kimono_awase': 'ç€ç‰©(è¢·)',
            'kimono_hitoe': 'ç€ç‰©(å˜è¡£)',
            'homongi_awase': 'è¨ªå•ç€(è¢·)',
            'homongi_hitoe': 'è¨ªå•ç€(å˜è¡£)',
            'tsukesage_awase': 'ä»˜ä¸‹ã’(è¢·)',
            'tsukesage_hitoe': 'ä»˜ä¸‹ã’(å˜è¡£)',
            'tsukesage_summer': 'ä»˜ä¸‹ã’(å¤ç‰©)',
            'nagajuban_awase': 'é•·è¥¦è¢¢(è¢·)',
            'nagajuban_hitoe': 'é•·è¥¦è¢¢(å˜è¡£)',
            'coat_awase': 'ã‚³ãƒ¼ãƒˆ(è¢·)',
            'coat_hitoe': 'ã‚³ãƒ¼ãƒˆ(å˜è¡£)',
            'obi': 'å¸¯',
            'small': 'å°ç‰©'
        };

        const categoryList = ['kimono_awase', 'kimono_hitoe', 'homongi_awase', 'homongi_hitoe', 'tsukesage_awase', 'tsukesage_hitoe', 'tsukesage_summer', 'nagajuban_awase', 'nagajuban_hitoe', 'coat_awase', 'coat_hitoe', 'obi', 'small'];

        function initPresetData() {
            const saved = localStorage.getItem('presetData');
            if (saved) presetData = JSON.parse(saved);
            else savePresetData();

            const savedFee = localStorage.getItem('feeStructureData');
            if (savedFee) feeStructureData = JSON.parse(savedFee);
            else saveFeeStructureData();

            initCardTypes();
            initCategoryDiscounts();
            initProductDiscountRates();
        }

        function initCardTypes() {
            const saved = localStorage.getItem('cardTypes');
            if (saved) {
                cardTypes = JSON.parse(saved);
            } else {
                cardTypes = [
                    {
                        id: 'jackx',
                        name: 'ã‚¸ãƒ£ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰',
                        payments: { 1: 0, 3: 0, 6: 0, 10: 0, 12: 1.2, 15: 3.0, 18: 4.8, 20: 6.0, 24: 8.4, 30: 12.0, 36: 15.6 },
                        skip: { 0: 0, 1: 0.5, 2: 1.0, 3: 1.5, 4: 2.0, 5: 2.5, 6: 3.0 }
                    },
                    {
                        id: 'kl',
                        name: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ»KL',
                        payments: { 1: 0, 3: 0, 6: 0, 10: 0, 12: 1.0, 15: 2.1, 18: 3.1, 20: 3.8, 24: 5.2, 30: 7.3, 36: 9.4 },
                        skip: { 0: 0, 1: 0.5, 2: 1.0, 3: 1.5, 4: 2.0, 5: 2.5, 6: 3.0 }
                    }
                ];
                saveCardTypes();
            }

            cardTypes.forEach(card => {
                if (!card.skipFees) {
                    card.skipFees = { 0: 0, 1: 0.5, 2: 1.0, 3: 1.5, 4: 2.0, 5: 2.5, 6: 3.0 };
                }
            });
            saveCardTypes();
        }

        function initCategoryDiscounts() {
            const saved = localStorage.getItem('categoryDiscounts');
            if (saved) {
                categoryDiscounts = JSON.parse(saved);
            } else {
                categoryDiscounts = {};
                categoryList.forEach(cat => {
                    categoryDiscounts[cat] = { student: 0, member: 0, instructor: 0 };
                });
                saveCategoryDiscounts();
            }
        }

        function saveCategoryDiscounts() {
            localStorage.setItem('categoryDiscounts', JSON.stringify(categoryDiscounts));
        }

        function saveCardTypes() {
            localStorage.setItem('cardTypes', JSON.stringify(cardTypes));
        }

        function savePresetData() {
            localStorage.setItem('presetData', JSON.stringify(presetData));
        }

        function saveFeeStructureData() {
            localStorage.setItem('feeStructureData', JSON.stringify(feeStructureData));
        }

        let products = [];
        let calculation = null;
        let productDiscountRates = {};

        function initProductDiscountRates() {
            const saved = localStorage.getItem('productDiscountRates');
            if (saved) {
                productDiscountRates = JSON.parse(saved);
            } else {
                productDiscountRates = {};
                saveProductDiscountRates();
            }
        }

        function saveProductDiscountRates() {
            localStorage.setItem('productDiscountRates', JSON.stringify(productDiscountRates));
        }

        function addProduct() {
            const id = Date.now();
            products.push({ id, category: 'kimono_awase', price: '' });
            renderProducts();
            updateCalculation();
        }

        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            renderProducts();
            updateCalculation();
        }

        function updateProduct(id, field, value) {
            const product = products.find(p => p.id === id);
            if (product) {
                product[field] = value;
                updateCalculation();
            }
        }

        function selectPreset(id, presetId) {
            const product = products.find(p => p.id === id);
            if (product && presetId) {
                const preset = presetData[product.category].find(p => p.id == presetId);
                if (preset) {
                    product.price = preset.price;
                    product.presetId = preset.id;
                    updateCalculation();
                }
            }
        }

        function renderProducts() {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 12px; text-align: center; padding: 12px;">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            container.innerHTML = products.map(product => {
                const isPresetCategory = ['guard', 'lining', 'tailor', 'other'].includes(product.category);
                const presetOptions = isPresetCategory ? presetData[product.category] : [];

                return `
                    <div class="product-item">
                        <div class="form-group">
                            <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                            <select onchange="updateProduct(${product.id}, 'category', this.value); renderProducts(); updateCalculation()">
                                <option value="kimono_awase" ${product.category === 'kimono_awase' ? 'selected' : ''}>ç€ç‰©(è¢·)</option>
                                <option value="kimono_hitoe" ${product.category === 'kimono_hitoe' ? 'selected' : ''}>ç€ç‰©(å˜è¡£)</option>
                                <option value="homongi_awase" ${product.category === 'homongi_awase' ? 'selected' : ''}>è¨ªå•ç€(è¢·)</option>
                                <option value="homongi_hitoe" ${product.category === 'homongi_hitoe' ? 'selected' : ''}>è¨ªå•ç€(å˜è¡£)</option>
                                <option value="tsukesage_awase" ${product.category === 'tsukesage_awase' ? 'selected' : ''}>ä»˜ä¸‹ã’(è¢·)</option>
                                <option value="tsukesage_hitoe" ${product.category === 'tsukesage_hitoe' ? 'selected' : ''}>ä»˜ä¸‹ã’(å˜è¡£)</option>
                                <option value="tsukesage_summer" ${product.category === 'tsukesage_summer' ? 'selected' : ''}>ä»˜ä¸‹ã’(å¤ç‰©)</option>
                                <option value="nagajuban_awase" ${product.category === 'nagajuban_awase' ? 'selected' : ''}>é•·è¥¦è¢¢(è¢·)</option>
                                <option value="nagajuban_hitoe" ${product.category === 'nagajuban_hitoe' ? 'selected' : ''}>é•·è¥¦è¢¢(å˜è¡£)</option>
                                <option value="coat_awase" ${product.category === 'coat_awase' ? 'selected' : ''}>ã‚³ãƒ¼ãƒˆ(è¢·)</option>
                                <option value="coat_hitoe" ${product.category === 'coat_hitoe' ? 'selected' : ''}>ã‚³ãƒ¼ãƒˆ(å˜è¡£)</option>
                                <option value="obi" ${product.category === 'obi' ? 'selected' : ''}>å¸¯</option>
                                <option value="small" ${product.category === 'small' ? 'selected' : ''}>å°ç‰©</option>
                                <option value="guard" ${product.category === 'guard' ? 'selected' : ''}>ã‚¬ãƒ¼ãƒ‰</option>
                                <option value="lining" ${product.category === 'lining' ? 'selected' : ''}>è£ç‰©</option>
                                <option value="tailor" ${product.category === 'tailor' ? 'selected' : ''}>ä»•ç«‹</option>
                                <option value="other" ${product.category === 'other' ? 'selected' : ''}>ãã®ä»–</option>
                            </select>
                        </div>
                        ${isPresetCategory ? `
                            <div class="form-group">
                                <label>å•†å“ã‚’é¸æŠ</label>
                                <select onchange="selectPreset(${product.id}, this.value); updateCalculation()">
                                    <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                                    ${presetOptions.map(item => `
                                        <option value="${item.id}" ${product.presetId === item.id ? 'selected' : ''}>${item.name} - Â¥${item.price.toLocaleString('ja-JP')}</option>
                                    `).join('')}
                                </select>
                            </div>
                        ` : `
                            <div class="form-group">
                                <label>å•†å“å˜ä¾¡ï¼ˆå††ï¼‰</label>
                                <input type="number" value="${product.price}" placeholder="0" onchange="updateProduct(${product.id}, 'price', this.value)" oninput="this.value = formatNumberInput(this.value); updateCalculation()">
                            </div>
                        `}
                        <button class="btn-remove" onclick="removeProduct(${product.id})">å‰Šé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function formatNumberInput(value) {
            return value.replace(/\D/g, '');
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ja-JP');
        }

        function getCategoryDiscount(category, customerType) {
            if (categoryDiscounts[category]) {
                return categoryDiscounts[category][customerType] || 0;
            }
            return 0;
        }

        function updateCalculation() {
            if (products.length === 0 || products.some(p => !p.price || isNaN(p.price))) {
                document.getElementById('resultsSection').style.display = 'none';
                return;
            }

            const customerType = document.getElementById('customerType').value;
            const jackxPayments = parseInt(document.getElementById('jackxPayments').value) || 1;
            const jackxSkip = parseInt(document.getElementById('jackxSkip').value) || 0;
            const klPayments = parseInt(document.getElementById('klPayments').value) || 1;
            const klSkip = parseInt(document.getElementById('klSkip').value) || 0;

            let totalBeforeFee = 0;
            let totalAfterDiscount = 0;
            let discountTotal = 0;
            let productDetails = [];

            products.forEach(product => {
                const price = parseFloat(product.price);
                let discountRate = 0;

                if (categoryList.includes(product.category)) {
                    discountRate = getCategoryDiscount(product.category, customerType);
                } else if ((product.category === 'tailor' || product.category === 'guard' || product.category === 'lining') && product.presetId) {
                    discountRate = getProductDiscount(product.category, product.presetId, customerType);
                }

                const discountAmount = price * (discountRate / 100);
                const priceAfterDiscount = price - discountAmount;

                totalBeforeFee += price;
                totalAfterDiscount += priceAfterDiscount;
                discountTotal += discountAmount;

                productDetails.push({
                    id: product.id,
                    category: product.category,
                    price: price,
                    discountRate: discountRate,
                    discountAmount: discountAmount,
                    priceAfterDiscount: priceAfterDiscount
                });
            });

            const jackxCard = cardTypes.find(c => c.id === 'jackx');
            const jackxFeeRate = jackxCard && jackxCard.payments[jackxPayments] !== undefined ? jackxCard.payments[jackxPayments] : 0;
            const jackxSkipFee = jackxCard && (jackxCard.skipFees && jackxCard.skipFees[jackxSkip] !== undefined) ? jackxCard.skipFees[jackxSkip] : 0;
            const jackxTotalFeeRate = jackxFeeRate + jackxSkipFee;
            const jackxPaymentFeeAmount = Math.floor(totalAfterDiscount * (jackxFeeRate / 100));
            const jackxSkipFeeAmount = Math.floor(totalAfterDiscount * (jackxSkipFee / 100));
            const jackxFeeAmount = jackxPaymentFeeAmount + jackxSkipFeeAmount;
            const jackxFinal = totalAfterDiscount + jackxFeeAmount;
            const jackxPerMonth = Math.floor(jackxFinal / jackxPayments * 100) / 100;

            const klCard = cardTypes.find(c => c.id === 'kl');
            const klFeeRate = klCard && klCard.payments[klPayments] !== undefined ? klCard.payments[klPayments] : 0;
            const klSkipFee = klCard && (klCard.skipFees && klCard.skipFees[klSkip] !== undefined) ? klCard.skipFees[klSkip] : 0;
            const klTotalFeeRate = klFeeRate + klSkipFee;
            const klPaymentFeeAmount = Math.floor(totalAfterDiscount * (klFeeRate / 100));
            const klSkipFeeAmount = Math.floor(totalAfterDiscount * (klSkipFee / 100));
            const klFeeAmount = klPaymentFeeAmount + klSkipFeeAmount;
            const klFinal = totalAfterDiscount + klFeeAmount;
            const klPerMonth = Math.floor(klFinal / klPayments * 100) / 100;

            calculation = {
                customerType,
                productDetails,
                totalBeforeFee,
                totalAfterDiscount,
                discountTotal,
                jackx: {
                    payments: jackxPayments,
                    skip: jackxSkip,
                    feeRate: jackxFeeRate,
                    skipFee: jackxSkipFee,
                    totalFeeRate: jackxTotalFeeRate,
                    paymentFeeAmount: jackxPaymentFeeAmount,
                    skipFeeAmount: jackxSkipFeeAmount,
                    feeAmount: jackxFeeAmount,
                    final: jackxFinal,
                    perMonth: jackxPerMonth
                },
                kl: {
                    payments: klPayments,
                    skip: klSkip,
                    feeRate: klFeeRate,
                    skipFee: klSkipFee,
                    totalFeeRate: klTotalFeeRate,
                    paymentFeeAmount: klPaymentFeeAmount,
                    skipFeeAmount: klSkipFeeAmount,
                    feeAmount: klFeeAmount,
                    final: klFinal,
                    perMonth: klPerMonth
                },
                timestamp: new Date()
            };

            const summaryHTML = `
                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border);">
                    <strong style="color: var(--color-primary); font-size: 13px;">ã‚¸ãƒ£ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰</strong>
                    <div class="summary-row">
                        <span class="summary-label">1. å€¤å¼•ãå‰åˆè¨ˆ</span>
                        <span class="summary-value">Â¥${formatNumber(totalBeforeFee)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">2. å€¤å¼•ãé‡‘é¡</span>
                        <span class="summary-value" style="color: var(--color-warning);">-Â¥${formatNumber(discountTotal)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">3. å€¤å¼•ãå¾Œåˆè¨ˆ</span>
                        <span class="summary-value">Â¥${formatNumber(totalAfterDiscount)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">4. æ‰‹æ•°æ–™</span>
                        <span class="summary-value">Â¥${formatNumber(jackxFeeAmount)} (${jackxTotalFeeRate.toFixed(1)}%)
                            <div class="skip-fee-breakdown">
                                <div>æ”¯æ‰•ã„å›æ•°æ‰‹æ•°æ–™: Â¥${formatNumber(jackxPaymentFeeAmount)} (${jackxFeeRate.toFixed(1)}%)</div>
                                <div>ã‚¹ã‚­ãƒƒãƒ—æ‰‹æ•°æ–™: Â¥${formatNumber(jackxSkipFeeAmount)} (${jackxSkipFee.toFixed(1)}%)</div>
                            </div>
                        </span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">5. æœ€çµ‚åˆè¨ˆ</span>
                        <span class="summary-value" style="color: var(--color-primary); font-weight: 700;">Â¥${formatNumber(jackxFinal)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">6. 1å›ã®æ”¯æ‰•ã„ï¼ˆ${jackxPayments}å›ï¼‰</span>
                        <span class="summary-value" style="color: var(--color-primary); font-weight: 700;">Â¥${formatNumber(jackxPerMonth)}</span>
                    </div>
                </div>
                <div>
                    <strong style="color: var(--color-primary); font-size: 13px;">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ»KL</strong>
                    <div class="summary-row">
                        <span class="summary-label">1. å€¤å¼•ãå‰åˆè¨ˆ</span>
                        <span class="summary-value">Â¥${formatNumber(totalBeforeFee)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">2. å€¤å¼•ãé‡‘é¡</span>
                        <span class="summary-value" style="color: var(--color-warning);">-Â¥${formatNumber(discountTotal)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">3. å€¤å¼•ãå¾Œåˆè¨ˆ</span>
                        <span class="summary-value">Â¥${formatNumber(totalAfterDiscount)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">4. æ‰‹æ•°æ–™</span>
                        <span class="summary-value">Â¥${formatNumber(klFeeAmount)} (${klTotalFeeRate.toFixed(1)}%)
                            <div class="skip-fee-breakdown">
                                <div>æ”¯æ‰•ã„å›æ•°æ‰‹æ•°æ–™: Â¥${formatNumber(klPaymentFeeAmount)} (${klFeeRate.toFixed(1)}%)</div>
                                <div>ã‚¹ã‚­ãƒƒãƒ—æ‰‹æ•°æ–™: Â¥${formatNumber(klSkipFeeAmount)} (${klSkipFee.toFixed(1)}%)</div>
                            </div>
                        </span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">5. æœ€çµ‚åˆè¨ˆ</span>
                        <span class="summary-value" style="color: var(--color-primary); font-weight: 700;">Â¥${formatNumber(klFinal)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">6. 1å›ã®æ”¯æ‰•ã„ï¼ˆ${klPayments}å›ï¼‰</span>
                        <span class="summary-value" style="color: var(--color-primary); font-weight: 700;">Â¥${formatNumber(klPerMonth)}</span>
                    </div>
                </div>
            `;

            document.getElementById('summaryDetails').innerHTML = summaryHTML;
            document.getElementById('resultsSection').style.display = 'block';
        }

        function renderCardSelects() {
            const section = document.getElementById('cardSelectionsSection');
            if (cardTypes.length === 0) {
                section.innerHTML = '';
                return;
            }

            section.innerHTML = cardTypes.map(card => `
                <section>
                    <h2>${card.name}</h2>
                    <div class="row">
                        <div class="form-group">
                            <label>æ”¯æ‰•ã„å›æ•°</label>
                            <select id="${card.id}Payments" onchange="updateCalculation()">
                                ${Object.keys(card.payments).map(p => `<option value="${p}">${p}å›</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ã‚¹ã‚­ãƒƒãƒ—å›æ•°</label>
                            <select id="${card.id}Skip" onchange="updateCalculation()">
                                ${Object.keys(card.skip).map(s => `<option value="${s}">${s}å›</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </section>
            `).join('');
        }

        function renderCardTypesTable() {
            const container = document.getElementById('cardTypesTable');
            container.innerHTML = cardTypes.map((card) => {
                const isDefault = card.id === 'jackx' || card.id === 'kl';
                return `
                    <div class="product-item">
                        <div class="form-group">
                            <label>ã‚«ãƒ¼ãƒ‰å</label>
                            <input type="text" value="${card.name}" ${isDefault ? 'disabled' : `onchange="updateCardName('${card.id}', this.value)"`}>
                        </div>
                        ${!isDefault ? `<button class="btn-remove" onclick="deleteCardType('${card.id}')">å‰Šé™¤</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateCardName(cardId, newName) {
            const card = cardTypes.find(c => c.id === cardId);
            if (card) {
                card.name = newName;
                saveCardTypes();
                renderCardSelects();
            }
        }

        function deleteCardType(cardId) {
            if (confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                cardTypes = cardTypes.filter(c => c.id !== cardId);
                saveCardTypes();
                renderCardSelects();
                renderCardTypesTable();
                renderCardPaymentTable();
                updateCalculation();
            }
        }

        function addCardType() {
            const newId = 'card_' + Date.now();
            cardTypes.push({
                id: newId,
                name: 'æ–°è¦ã‚«ãƒ¼ãƒ‰',
                payments: { 1: 0, 3: 0, 6: 0, 10: 0, 12: 0, 15: 0, 18: 0, 20: 0, 24: 0, 30: 0, 36: 0 },
                skip: { 0: 0, 1: 0.5, 2: 1.0, 3: 1.5, 4: 2.0, 5: 2.5, 6: 3.0 }
            });
            saveCardTypes();
            renderCardSelects();
            renderCardTypesTable();
            renderCardPaymentTable();
            updateCalculation();
        }

        function renderCardPaymentTable() {
            const container = document.getElementById('cardPaymentTable');
            let html = '';

            cardTypes.forEach(card => {
                html += `
                    <div style="margin-bottom: 12px;">
                        <h3 style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--color-primary);">${card.name}</h3>
                        ${Object.entries(card.payments).map(([payments, fee]) => `
                            <div class="product-item" style="margin-bottom: 6px;">
                                <div class="row">
                                    <div class="form-group">
                                        <label style="font-size: 11px;">æ”¯æ‰•ã„å›æ•°</label>
                                        <input type="text" value="${payments}å›" disabled style="background: #f5f5f5;">
                                    </div>
                                    <div class="form-group">
                                        <label style="font-size: 11px;">æ‰‹æ•°æ–™ (%)</label>
                                        <input type="number" value="${fee}" step="0.1" min="0" onchange="updateCardPayment('${card.id}', ${payments}, this.value)">
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderCardSkipFeeTable() {
            const container = document.getElementById('cardSkipFeeTable');
            let html = '';

            cardTypes.forEach(card => {
                html += `
                    <div style="margin-bottom: 12px;">
                        <h3 style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--color-primary);">${card.name}</h3>
                        ${Object.entries(card.skipFees || { 0: 0, 1: 0.5, 2: 1.0, 3: 1.5, 4: 2.0, 5: 2.5, 6: 3.0 }).map(([skip, fee]) => `
                            <div class="product-item" style="margin-bottom: 6px;">
                                <div class="row">
                                    <div class="form-group">
                                        <label style="font-size: 11px;">ã‚¹ã‚­ãƒƒãƒ—æœˆæ•°</label>
                                        <input type="text" value="${skip}ãƒ¶æœˆ" disabled style="background: #f5f5f5;">
                                    </div>
                                    <div class="form-group">
                                        <label style="font-size: 11px;">æ‰‹æ•°æ–™ (%)</label>
                                        <input type="number" value="${fee}" step="0.1" min="0" onchange="updateCardSkipFee('${card.id}', ${skip}, this.value)">
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateCardPayment(cardId, payments, fee) {
            const card = cardTypes.find(c => c.id === cardId);
            if (card) {
                card.payments[payments] = parseFloat(fee) || 0;
                saveCardTypes();
                updateCalculation();
            }
        }

        function updateCardSkipFee(cardId, skip, fee) {
            const card = cardTypes.find(c => c.id === cardId);
            if (card) {
                if (!card.skipFees) {
                    card.skipFees = {};
                }
                card.skipFees[skip] = parseFloat(fee) || 0;
                saveCardTypes();
                updateCalculation();
            }
        }

        function addPresetItem(category) {
            const newId = Math.max(...presetData[category].map(p => p.id || 0), 0) + 1;
            presetData[category].push({
                id: newId,
                name: `æ–°è¦ï¼ˆÂ¥0ï¼‰`,
                price: 0
            });
            savePresetData();
            renderPresetList(category);
        }

        function updatePresetItem(category, index, field, value) {
            if (field === 'price') {
                presetData[category][index].price = parseInt(value) || 0;
            } else {
                presetData[category][index].name = value;
            }
            savePresetData();
            renderPresetList(category);
        }

        function deletePresetItem(category, index) {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                presetData[category].splice(index, 1);
                savePresetData();
                renderPresetList(category);
            }
        }

        function renderPresetListWithDiscounts(category) {
            const container = document.getElementById(category === 'guard' ? 'guardList' : category === 'lining' ? 'liningList' : category === 'tailor' ? 'tailorList' : 'otherList');

            container.innerHTML = presetData[category].map((item, index) => {
                const showDiscounts = ['guard', 'lining', 'tailor'].includes(category);
                const productDiscounts = productDiscountRates[`${category}_${item.id}`] || { student: 0, member: 0, instructor: 0 };

                return `
                    <div class="product-item">
                        <div class="form-group">
                            <label>å•†å“å</label>
                            <input type="text" value="${item.name}" onchange="updatePresetItem('${category}', ${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" value="${item.price}" placeholder="0" onchange="updatePresetItem('${category}', ${index}, 'price', this.value)" oninput="this.value = formatNumberInput(this.value)">
                        </div>
                        ${showDiscounts ? `
                        <div style="background: #f0f0f0; border-radius: 4px; padding: 8px; margin-bottom: 8px;">
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 6px;">å‰²å¼•ç‡è¨­å®š</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <div>
                                    <label style="font-size: 10px;">ä¿®ç§‘ç”Ÿ (%)</label>
                                    <input type="number" value="${productDiscounts.student || 0}" onchange="updateProductDiscount('${category}', ${item.id}, 'student', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                                </div>
                                <div>
                                    <label style="font-size: 10px;">ã—ã‚…ã†ç¾ä¼šç”Ÿ (%)</label>
                                    <input type="number" value="${productDiscounts.member || 0}" onchange="updateProductDiscount('${category}', ${item.id}, 'member', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                                </div>
                                <div>
                                    <label style="font-size: 10px;">è¬›å¸« (%)</label>
                                    <input type="number" value="${productDiscounts.instructor || 0}" onchange="updateProductDiscount('${category}', ${item.id}, 'instructor', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <button class="btn-remove" onclick="deletePresetItem('${category}', ${index})">å‰Šé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function renderPresetList(category) {
            renderPresetListWithDiscounts(category);
        }

        function renderCategoryDiscountList() {
            const container = document.getElementById('categoryDiscountList');

            container.innerHTML = categoryList.map(category => `
                <div class="product-item">
                    <div class="form-group">
                        <label style="font-weight: 600;">${categoryLabels[category]}</label>
                    </div>
                    <div style="background: #f0f0f0; border-radius: 4px; padding: 8px; margin-bottom: 8px;">
                        <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 6px;">å‰²å¼•ç‡è¨­å®š</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                            <div>
                                <label style="font-size: 10px;">ä¿®ç§‘ç”Ÿ (%)</label>
                                <input type="number" value="${categoryDiscounts[category]?.student || 0}" onchange="updateCategoryDiscount('${category}', 'student', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                            </div>
                            <div>
                                <label style="font-size: 10px;">ã—ã‚…ã†ç¾ä¼šç”Ÿ (%)</label>
                                <input type="number" value="${categoryDiscounts[category]?.member || 0}" onchange="updateCategoryDiscount('${category}', 'member', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                            </div>
                            <div>
                                <label style="font-size: 10px;">è¬›å¸« (%)</label>
                                <input type="number" value="${categoryDiscounts[category]?.instructor || 0}" onchange="updateCategoryDiscount('${category}', 'instructor', this.value)" step="0.1" min="0" max="100" style="width: 100%; padding: 4px; font-size: 11px;">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateCategoryDiscount(category, customerType, value) {
            if (!categoryDiscounts[category]) {
                categoryDiscounts[category] = { student: 0, member: 0, instructor: 0 };
            }
            categoryDiscounts[category][customerType] = parseFloat(value) || 0;
            saveCategoryDiscounts();
            updateCalculation();
        }

        function updateProductDiscount(category, productId, customerType, value) {
            const key = `${category}_${productId}`;
            if (!productDiscountRates[key]) {
                productDiscountRates[key] = { student: 0, member: 0, instructor: 0 };
            }
            productDiscountRates[key][customerType] = parseFloat(value) || 0;
            saveProductDiscountRates();
            updateCalculation();
        }

        function getProductDiscount(category, productId, customerType) {
            const key = `${category}_${productId}`;
            if (productDiscountRates[key]) {
                return productDiscountRates[key][customerType] || 0;
            }
            return 0;
        }

        let calculationHistory = [];

        function loadHistory() {
            const saved = localStorage.getItem('calculationHistory');
            if (saved) calculationHistory = JSON.parse(saved);
        }

        function saveToHistory() {
            if (!calculation) return;
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 100) calculationHistory.pop();
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
            renderHistory();
            alert('è¨ˆç®—çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function renderHistory() {
            const container = document.getElementById('historySection');
            if (calculationHistory.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">è¨ˆç®—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            container.innerHTML = calculationHistory.map((calc, index) => {
                const date = new Date(calc.timestamp);
                const timeStr = date.toLocaleString('ja-JP');
                const jackxTotal = calc.jackx.final;
                const klTotal = calc.kl.final;

                return `
                    <div class="history-item" onclick="showCalculationDetail(${index})">
                        <div class="history-time">${timeStr}</div>
                        <div class="history-customer">é¡§å®¢ç¨®åˆ¥: ${calc.customerType === 'student' ? 'ä¿®ç§‘ç”Ÿ' : calc.customerType === 'member' ? 'ã—ã‚…ã†ç¾ä¼šç”Ÿ' : 'è¬›å¸«'}</div>
                        <div class="history-total">ã‚¸ãƒ£ãƒƒã‚¯ã‚¹: Â¥${formatNumber(jackxTotal)}</div>
                        <div class="history-detail">KL: Â¥${formatNumber(klTotal)}</div>
                        <button class="btn-delete" onclick="event.stopPropagation(); deleteHistoryItem(${index})">å‰Šé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function showCalculationDetail(index) {
            const calc = calculationHistory[index];
            const detailContent = document.getElementById('detailContent');

            const productDetailsHTML = calc.productDetails.map(p => `
                <div class="detail-item">
                    <span>${categoryLabels[p.category] || p.category}</span>
                    <span>Â¥${formatNumber(p.price)} â†’ Â¥${formatNumber(p.priceAfterDiscount)} (å‰²å¼•: ${p.discountRate}%)</span>
                </div>
            `).join('');

            detailContent.innerHTML = `
                <h2 style="font-size: 16px; margin-bottom: 12px;">è¨ˆç®—çµæœè©³ç´°</h2>
                <div class="detail-section">
                    <h3>åŸºæœ¬æƒ…å ±</h3>
                    <div class="detail-item">
                        <span>é¡§å®¢ç¨®åˆ¥</span>
                        <span>${calc.customerType === 'student' ? 'ä¿®ç§‘ç”Ÿ' : calc.customerType === 'member' ? 'ã—ã‚…ã†ç¾ä¼šç”Ÿ' : 'è¬›å¸«'}</span>
                    </div>
                    <div class="detail-item">
                        <span>æ—¥æ™‚</span>
                        <span>${new Date(calc.timestamp).toLocaleString('ja-JP')}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>å•†å“æ˜ç´°</h3>
                    ${productDetailsHTML}
                </div>

                <div class="detail-section">
                    <h3>ã‚¸ãƒ£ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰</h3>
                    <div class="detail-item">
                        <span>æ”¯æ‰•ã„å›æ•°</span>
                        <span>${calc.jackx.payments}å›</span>
                    </div>
                    <div class="detail-item">
                        <span>ã‚¹ã‚­ãƒƒãƒ—æœˆæ•°</span>
                        <span>${calc.jackx.skip}ãƒ¶æœˆ</span>
                    </div>
                    <div class="detail-item">
                        <span>æ”¯æ‰•ã„å›æ•°æ‰‹æ•°æ–™</span>
                        <span>Â¥${formatNumber(calc.jackx.paymentFeeAmount)} (${calc.jackx.feeRate.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>ã‚¹ã‚­ãƒƒãƒ—æ‰‹æ•°æ–™</span>
                        <span>Â¥${formatNumber(calc.jackx.skipFeeAmount)} (${calc.jackx.skipFee.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>åˆè¨ˆæ‰‹æ•°æ–™</span>
                        <span style="font-weight: 600;">Â¥${formatNumber(calc.jackx.feeAmount)} (${calc.jackx.totalFeeRate.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>æœ€çµ‚åˆè¨ˆ</span>
                        <span style="font-weight: 600; color: var(--color-primary);">Â¥${formatNumber(calc.jackx.final)}</span>
                    </div>
                    <div class="detail-item">
                        <span>1å›ã®æ”¯æ‰•ã„</span>
                        <span style="font-weight: 600; color: var(--color-primary);">Â¥${formatNumber(calc.jackx.perMonth)}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ»KL</h3>
                    <div class="detail-item">
                        <span>æ”¯æ‰•ã„å›æ•°</span>
                        <span>${calc.kl.payments}å›</span>
                    </div>
                    <div class="detail-item">
                        <span>ã‚¹ã‚­ãƒƒãƒ—æœˆæ•°</span>
                        <span>${calc.kl.skip}ãƒ¶æœˆ</span>
                    </div>
                    <div class="detail-item">
                        <span>æ”¯æ‰•ã„å›æ•°æ‰‹æ•°æ–™</span>
                        <span>Â¥${formatNumber(calc.kl.paymentFeeAmount)} (${calc.kl.feeRate.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>ã‚¹ã‚­ãƒƒãƒ—æ‰‹æ•°æ–™</span>
                        <span>Â¥${formatNumber(calc.kl.skipFeeAmount)} (${calc.kl.skipFee.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>åˆè¨ˆæ‰‹æ•°æ–™</span>
                        <span style="font-weight: 600;">Â¥${formatNumber(calc.kl.feeAmount)} (${calc.kl.totalFeeRate.toFixed(1)}%)</span>
                    </div>
                    <div class="detail-item">
                        <span>æœ€çµ‚åˆè¨ˆ</span>
                        <span style="font-weight: 600; color: var(--color-primary);">Â¥${formatNumber(calc.kl.final)}</span>
                    </div>
                    <div class="detail-item">
                        <span>1å›ã®æ”¯æ‰•ã„</span>
                        <span style="font-weight: 600; color: var(--color-primary);">Â¥${formatNumber(calc.kl.perMonth)}</span>
                    </div>
                </div>

                <button class="modal-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function deleteHistoryItem(index) {
            if (confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                calculationHistory.splice(index, 1);
                localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
                renderHistory();
            }
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');

            tabs.forEach(t => t.classList.remove('active'));
            buttons.forEach(b => b.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'preset') {
                renderCardTypesTable();
                renderCardPaymentTable();
                renderCardSkipFeeTable();
                renderPresetListWithDiscounts('guard');
                renderPresetListWithDiscounts('lining');
                renderPresetListWithDiscounts('tailor');
                renderPresetListWithDiscounts('other');
                renderCategoryDiscountList();
            }
        }

        function downloadApp() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'åˆ†å‰²æ‰‹æ•°æ–™è¨ˆç®—ã‚¢ãƒ—ãƒª.html');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const correctPassword = '1234';

            if (input === correctPassword) {
                document.getElementById('passwordOverlay').style.display = 'none';
                document.querySelector('.main-content').classList.add('unlocked');
                initPresetData();
                renderCardSelects();
                loadHistory();
                renderHistory();
                addProduct();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });
    </script>
</body>
</html>
